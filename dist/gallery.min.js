define(["require","exports","jquery","handlebars","./modal"],function(t,e,a,i,n){var r=function(){function t(t,e){e===void 0&&(e={}),this.$container=t,this.$pagination=t.find(".pagination"),this.api_url=e.api_url||window.location.pathname+"/gallery.json",this.data=e.data||null,this.api_params={},this.items_per_page=parseInt(e.items_per_page||2,10);var r=e.item_template||"#gallery-item-template",o=e.group_template||"#gallery-group-template",s=a(r).html(),l=a(o).html();this.compiled_item_template=i.compile(s),this.compiled_group_template=i.compile(l),this.category=[],this.types=[],this.modal=new n.Modal(t.find(".modal"),this),this.beforeInit(),this.update(),this.afterInit()}return t.prototype.beforeInit=function(){},t.prototype.afterInit=function(){},t.prototype.update=function(){var t=this;this.data?this.callback(this.data):a.getJSON(this.api_url,this.api_params,function(e){t.callback(e)})},t.prototype.callback=function(t){var e=this;a(".groups",this.$container).empty(),this.$pagination.empty();var i=function(t,e){var a=[];if(t&&t.length){for(;t.length>0;)a.push(t.splice(0,e));return a}return[]}(t.items,this.items_per_page),n=1;a.each(i,function(t,i){var r="";a.each(i,function(a,i){i.page=t+1,i.item_index=n;var o=e.compiled_item_template(i);r+=o,n+=1});var o=e.compiled_group_template({data:r});a(".groups",e.$container).append(o)});var r=function(t){var i=a(t.currentTarget),n=i.data("i");t.preventDefault(),a(".state-current",i.closest(".pagination")).removeClass("state-current"),i.parent().addClass("state-current"),a(".group.state-current",e.$container).removeClass("state-current"),a(a(".group",e.$container)[n-1]).addClass("state-current")},o=this.$container.find(".group");a(o[0]).first().addClass("state-current");for(var s=1;o.length>=s;s++){var l=a("<li>"),p=a('<a href="#"><span class="visual-hide">Page </span>'+s+"</a>");1===s&&l.addClass("state-current"),p.attr("data-i",s),p.on("click",r),l.append(p),this.$pagination.append(l)}this.handleExpand()},t.prototype.setPage=function(t){console.log("set page to "+t),this.$pagination.find("a")[t-1].click()},t.prototype.getPageGroup=function(t){return this.$container.find(".group")[t-1]},t.prototype.getCurrentPageNumber=function(){return parseInt(this.$pagination.find(".state-current a").data("i"),10)},t.prototype.getTotalPages=function(){return this.$pagination.find(".state-current a").data("i")},t.prototype.handleExpand=function(){var t=this;a("a.expand",this.$container).click(function(e){e.preventDefault(),t.setActive(a(this).parent())})},t.prototype.findPrevItem=function(t){var e=t.prev(".gallery-item"),i=this.getCurrentPageNumber();return e.length||i>1&&(e=a(this.getPageGroup(i-1)).find(".gallery-item:last")),e},t.prototype.findNextItem=function(t){var e=t.next(".gallery-item"),i=this.getCurrentPageNumber();return e.length||this.$container.find(".group").length>i&&(e=a(this.getPageGroup(i+1)).find(".gallery-item:first")),e},t.prototype.setActive=function(t){var e,a,i=t.find(".gallery-item-full").clone(),n=this.getCurrentPageNumber();console.log(t),console.log(n),console.log(t.data("page")),n!==t.data("page")&&this.setPage(t.data("page")),e=this.findPrevItem(t).length>0,a=this.findNextItem(t).length>0,this.$container.find(".gallery-item.state-active").removeClass("state-active"),t.addClass("state-active"),t.data("youtube-id")?i.find(".expanded-media").append('<iframe width="100%" height="400" src="//www.youtube.com/embed/'+t.data("youtube-id")+'" frameborder="0" allowfullscreen="allowfullscreen"></iframe>'):i.find(".expanded-media").append('<img src="'+t.data("image-large")+'" alt="'+t.find(".expand img").attr("alt")+'">'),this.modal.setContent(i,e,a),this.modal.setHeading(t.data("item-index")+" of "+this.$container.find(".gallery-item").length),this.modal.show()},t.prototype.handleNextPrev=function(t){var e=this.$container.find(".gallery-item.state-active");"next"===t?this.setActive(this.findNextItem(e)):this.setActive(this.findPrevItem(e))},t}();e.Gallery=r});