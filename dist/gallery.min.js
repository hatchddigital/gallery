define(["require","exports","jquery","handlebars","./modal"],function(t,e,a,n,i){var r=function(){function t(t,e){void 0===e&&(e={}),n.registerHelper("json",function(t){return JSON.stringify(t)}),this.$container=t,this.$pagination=t.find(".pagination"),this.modal_open_callback=e.modal_open_callback||null,this.api_url=e.api_url||window.location.pathname+"/gallery.json",this.data=e.data||null,this.api_params={},this.items_per_page=parseInt(e.items_per_page||12,10),this.prev_count=parseInt(e.prev_count,10)||null,this.next_count=parseInt(e.next_count,10)||null;var r=e.item_template||"#gallery-item-template",o=e.group_template||"#gallery-group-template",l=a(r).html(),s=a(o).html();this.compiled_item_template=n.compile(l),this.compiled_group_template=n.compile(s),this.category=[],this.types=[];var p=t.find(".modal");this.modal=new i.Modal(p.clone().appendTo(a("body")),this),this.beforeInit(),this.update(),this.afterInit()}return t.prototype.beforeInit=function(){},t.prototype.afterInit=function(){},t.prototype.update=function(){var t=this;this.data?this.callback(this.data):a.getJSON(this.api_url,this.api_params,function(e){t.callback(e)})},t.prototype.callback=function(t){var e=this;a(".gallery-groups",this.$container).empty(),this.$pagination.empty();var n=function(t,e){var a=[];if(t&&t.length){for(;t.length>0;)a.push(t.splice(0,e));return a}return[]}(t.items,this.items_per_page),i=1;a.each(n,function(t,n){var r="";a.each(n,function(a,n){n.page=t+1,n.item_index=i;var o=e.compiled_item_template(n);r+=o,i+=1});var o=e.compiled_group_template({data:r});e.$container.find(".gallery-groups").append(o)}),this.setupPagination()},t.prototype.setupPagination=function(){var t=this,e=function(e){var n=a(e.currentTarget),i=n.data("i");e.preventDefault(),a(".state--current",n.closest(".pagination")).removeClass("state--current"),n.parent().addClass("state--current"),a(".gallery-group.state--current",t.$container).removeClass("state--current"),a(a(".gallery-group",t.$container)[i-1]).addClass("state--current"),t.$pagination.find(".pagination-control--prev, .pagination-control--next").removeClass("inactive"),1===i&&t.$pagination.find(".pagination-control--prev").addClass("inactive"),i===t.$pagination.find(".pagination-control--pages a").length&&t.$pagination.find(".pagination-control--next").addClass("inactive"),t.processViewablePageLinks(i)},n=this.$container.find(".gallery-group"),i=a('<ul class="pagination-controls" />'),r=a('<ul class="pagination-controls pagination-control--pages" />');n.length>1&&i.append('<li class="pagination-control pagination-control--prev"><a href="#">Previous</a></li>'),i.append(r),n.length>1&&i.append('<li class="pagination-control pagination-control--next"><a href="#">Next</a></li>'),i.find(".pagination-control a").on("click",function(e){e.preventDefault();var n=a(e.currentTarget);n.parent().hasClass("pagination-control--prev")&&t.setPage(t.getCurrentPageNumber()-1),n.parent().hasClass("pagination-control--next")&&t.setPage(t.getCurrentPageNumber()+1)});for(var o=1;n.length>=o;o++){var l=a('<li class="pagination-control">'),s=a('<a href="#"><span class="visual-hide">Page </span>'+o+"</a>");s.attr("data-i",o),s.on("click",e),l.append(s),r.append(l)}this.$pagination.append(i),this.setPage(1),this.handleExpand(),n.length>1?this.$pagination.removeClass("state--hidden"):this.$pagination.addClass("state--hidden")},t.prototype.setPage=function(t){a(this.$pagination.find(".pagination-control--pages a")[t-1]).click()},t.prototype.processViewablePageLinks=function(t){var e=1,n=this.$pagination.find("a[data-i]").length-1;this.prev_count&&(e=t-this.prev_count),this.next_count&&(n=t+this.next_count),this.$pagination.find("a[data-i]").each(function(t,i){var r=a(i).data("i");e>r||r>n?a(i).parent().hide():a(i).parent().show()})},t.prototype.getPageGroup=function(t){return this.$container.find(".gallery-group")[t-1]},t.prototype.getCurrentPageNumber=function(){return parseInt(this.$pagination.find(".state--current a").data("i"),10)},t.prototype.handleExpand=function(){var t=this;a("a.expand",this.$container).click(function(e){e.preventDefault(),t.setActive(a(this).parent())})},t.prototype.findPrevItem=function(t){var e=t.prev(".gallery-item"),n=this.getCurrentPageNumber();return e.length||n>1&&(e=a(this.getPageGroup(n-1)).find(".gallery-item:last")),e},t.prototype.findNextItem=function(t){var e=t.next(".gallery-item"),n=this.getCurrentPageNumber();return e.length||this.$container.find(".gallery-group").length>n&&(e=a(this.getPageGroup(n+1)).find(".gallery-item:first")),e},t.prototype.setActive=function(t){var e,n,i=t.find(".gallery-item-full").clone(),r=this.getCurrentPageNumber();r!==t.data("page")&&this.setPage(t.data("page")),e=this.findPrevItem(t).length>0,n=this.findNextItem(t).length>0,this.$container.find(".gallery-item.state--active").removeClass("state--active"),t.addClass("state--active"),t.data("youtube-id")?(i.find(".modal-media .modal-media-src").append('<iframe width="560" height="315" src="//www.youtube.com/embed/'+t.data("youtube-id")+'?rel=0" frameborder="0" allowfullscreen="allowfullscreen"></iframe>'),a.fn.fitVids&&i.find(".modal-media .modal-media-src").fitVids()):i.find(".modal-media .modal-media-src").append(a("<img />").attr(t.data("image-large"))),this.modal.setContent(i.html(),e,n),this.modal.setHeading(t.data("item-index")+" of "+this.$container.find(".gallery-item").length),this.modal.show(),null!==this.modal_open_callback&&this.modal_open_callback()},t.prototype.handleNextPrev=function(t){var e=this.$container.find(".gallery-item.state--active");"next"===t?this.setActive(this.findNextItem(e)):this.setActive(this.findPrevItem(e))},t}();e.Gallery=r});