define(["require","exports","jquery","handlebars","./modal"],function(a,b,c,d,e){var f=function(){function a(a,b){void 0===b&&(b={}),d.registerHelper("json",function(a){return JSON.stringify(a)}),this.$container=a,this.$pagination=a.find(".pagination"),this.modal_open_callback=b.modal_open_callback||null,this.api_url=b.api_url||window.location.pathname+"/gallery.json",this.data=b.data||null,this.pagination_callback=b.pagination_callback||null,this.api_params={},this.items_per_page=parseInt(b.items_per_page||12,10),this.prev_count=parseInt(b.prev_count,10)||null,this.next_count=parseInt(b.next_count,10)||null;var f=b.item_template||"#gallery-item-template",g=b.group_template||"#gallery-group-template",h=c(f).html(),i=c(g).html();this.compiled_item_template=d.compile(h),this.compiled_group_template=d.compile(i),this.category=[],this.types=[];var j=a.find(".modal");this.modal=new e.Modal(j.clone().appendTo(c("body")),this),this.beforeInit(),this.update(),this.afterInit()}return a.prototype.beforeInit=function(){},a.prototype.afterInit=function(){},a.prototype.update=function(){var a=this;this.data?this.callback(this.data):c.getJSON(this.api_url,this.api_params,function(b){a.callback(b)})},a.prototype.callback=function(a){var b=this;c(".gallery-groups",this.$container).empty(),this.$pagination.empty();var d=function(a,b){var c=[];if(a&&a.length){for(;a.length>0;)c.push(a.splice(0,b));return c}return[]}(a.items,this.items_per_page),e=1;c.each(d,function(a,d){var f="";c.each(d,function(c,d){d.page=a+1,d.item_index=e;var g=b.compiled_item_template(d);f+=g,e+=1});var g=b.compiled_group_template({data:f});b.$container.find(".gallery-groups").append(g)}),this.setupPagination()},a.prototype.setupPagination=function(){var a=this,b=function(b){var d=c(b.currentTarget),e=d.data("i");b.preventDefault(),c(".state--current",d.closest(".pagination")).removeClass("state--current"),d.parent().addClass("state--current"),c(".gallery-group.state--current",a.$container).removeClass("state--current"),c(c(".gallery-group",a.$container)[e-1]).addClass("state--current"),a.$pagination.find(".pagination-control--prev, .pagination-control--next").removeClass("inactive"),1===e&&a.$pagination.find(".pagination-control--prev").addClass("inactive"),e===a.$pagination.find(".pagination-control--pages a").length&&a.$pagination.find(".pagination-control--next").addClass("inactive"),a.processViewablePageLinks(e),a.pagination_callback&&a.pagination_callback(a)},d=this.$container.find(".gallery-group"),e=c('<ul class="pagination-controls" />'),f=c('<ul class="pagination-controls pagination-control--pages" />');d.length>1&&e.append('<li class="pagination-control pagination-control--prev"><a href="#">Previous</a></li>'),e.append(f),d.length>1&&e.append('<li class="pagination-control pagination-control--next"><a href="#">Next</a></li>'),e.find(".pagination-control a").on("click",function(b){b.preventDefault();var d=c(b.currentTarget);d.parent().hasClass("pagination-control--prev")&&a.setPage(a.getCurrentPageNumber()-1),d.parent().hasClass("pagination-control--next")&&a.setPage(a.getCurrentPageNumber()+1)});for(var g=1;g<=d.length;g++){var h=c('<li class="pagination-control">'),i=c('<a href="#"><span class="visual-hide">Page </span>'+g+"</a>");i.attr("data-i",g),i.on("click",b),h.append(i),f.append(h)}this.$pagination.append(e),this.setPage(1),this.handleExpand(),d.length>1?this.$pagination.removeClass("state--hidden"):this.$pagination.addClass("state--hidden")},a.prototype.setPage=function(a){c(this.$pagination.find(".pagination-control--pages a")[a-1]).click()},a.prototype.processViewablePageLinks=function(a){var b=1,d=this.$pagination.find("a[data-i]").length-1;this.prev_count&&(b=a-this.prev_count),this.next_count&&(d=a+this.next_count),this.$pagination.find("a[data-i]").each(function(a,e){var f=c(e).data("i");b>f||f>d+1?c(e).parent().hide():c(e).parent().show()})},a.prototype.getPageGroup=function(a){return this.$container.find(".gallery-group")[a-1]},a.prototype.getCurrentPageNumber=function(){return parseInt(this.$pagination.find(".state--current a").data("i"),10)},a.prototype.handleExpand=function(){var a=this;c("a.expand",this.$container).click(function(b){b.preventDefault(),a.setActive(c(this).parent())})},a.prototype.findPrevItem=function(a){var b=a.prev(".gallery-item"),d=this.getCurrentPageNumber();return b.length||d>1&&(b=c(this.getPageGroup(d-1)).find(".gallery-item:last")),b},a.prototype.findNextItem=function(a){var b=a.next(".gallery-item"),d=this.getCurrentPageNumber();return b.length||d<this.$container.find(".gallery-group").length&&(b=c(this.getPageGroup(d+1)).find(".gallery-item:first")),b},a.prototype.setActive=function(a){var b,d,e=a.find(".gallery-item-full").clone(),f=this.getCurrentPageNumber();f!==a.data("page")&&this.setPage(a.data("page")),b=this.findPrevItem(a).length>0,d=this.findNextItem(a).length>0,this.$container.find(".gallery-item.state--active").removeClass("state--active"),a.addClass("state--active"),a.data("youtube-id")?(e.find(".modal-media .modal-media-src").append('<iframe width="560" height="315" src="//www.youtube.com/embed/'+a.data("youtube-id")+'?rel=0" frameborder="0" allowfullscreen="allowfullscreen"></iframe>'),c.fn.fitVids&&e.find(".modal-media .modal-media-src").fitVids()):e.find(".modal-media .modal-media-src").append(c("<img />").attr(a.data("image-large"))),this.modal.setContent(e.html(),b,d),this.modal.setHeading(a.data("item-index")+" of "+this.$container.find(".gallery-item").length),this.modal.show(),null!==this.modal_open_callback&&this.modal_open_callback(),this.pagination_callback&&this.pagination_callback(this)},a.prototype.handleNextPrev=function(a){var b=this.$container.find(".gallery-item.state--active");this.setActive("next"===a?this.findNextItem(b):this.findPrevItem(b))},a}();b.Gallery=f});